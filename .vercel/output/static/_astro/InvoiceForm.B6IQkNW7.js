import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as n}from"./index.BbCjBGhI.js";import{u as U,C as f,b as v,c as N,a as b}from"./card.DRHvi6JW.js";import{I as o}from"./index.D9xJzycJ.js";import{L as u,T as X}from"./textarea.CScGMZiN.js";import{B as w}from"./button.CoVCTGaF.js";import{S as F,a as V,b as B,c as M,d as y}from"./select.m9jejSwE.js";import{T as J,a as K,b as z,c as h,d as Q,e as j}from"./table.C0l1eO0d.js";import{B as L}from"./badge.BkV2C6_v.js";import{I as W}from"./InvoiceTemplate.CpmvSFwM.js";import{c as R}from"./utils.DWbH76R9.js";import{P as Y,T as Z}from"./trash-2.DUN9syJc.js";import"./_commonjsHelpers.D6-XlEtG.js";import"./storage.0hWDOvc9.js";import"./index.Bbz0MuBC.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],se=R("circle-x",ee);/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],te=R("save",ae),ve=()=>{const{settings:m,customers:C,saveInvoice:$,getNextInvoiceNumber:D,getCustomer:q}=U(),[i,d]=n.useState({invoiceNumber:"",customerId:"",customerName:"",date:new Date().toISOString().split("T")[0],dueDate:new Date(Date.now()+720*60*60*1e3).toISOString().split("T")[0],status:"draft",notes:"",items:[]}),[r,I]=n.useState([]),[p,H]=n.useState("");n.useEffect(()=>{d(t=>({...t,invoiceNumber:D()}));const a=new URLSearchParams(window.location.search).get("customerId");a&&k(a)},[D]);const k=s=>{H(s);const a=q(s);a&&d(t=>({...t,customerId:s,customerName:a.name}))},E=()=>{const s={id:`item-${Date.now()}`,description:"",quantity:1,unitPrice:0,total:0};I(a=>[...a,s])},O=s=>{I(a=>a.filter(t=>t.id!==s))},S=(s,a,t)=>{I(G=>G.map(P=>{if(P.id===s){const g={...P,[a]:a==="description"?t:parseFloat(t)||0};return g.total=g.quantity*g.unitPrice,g}return P}))},c=n.useMemo(()=>r.reduce((s,a)=>s+a.total,0),[r]),x=n.useMemo(()=>c*(m.taxPercentage/100),[c,m.taxPercentage]),T=n.useMemo(()=>c+x,[c,x]),l=n.useMemo(()=>C.find(s=>s.id===p),[C,p]),_=s=>{if(s.preventDefault(),!p){alert("Por favor selecciona un cliente");return}if(r.length===0||r.length===1&&!r[0].description){alert("Por favor agrega al menos un item con descripción");return}const a={...i,items:r.filter(t=>t.description),subtotal:c,tax:x,taxPercentage:m.taxPercentage,total:T};try{$(a),window.location.href="/facturas"}catch(t){console.error(t),alert("Ocurrió un error al guardar la factura")}},A=()=>{confirm("¿Estás seguro de cancelar? Los cambios se perderán.")&&(window.location.href="/facturas")};return n.useEffect(()=>{r.length===0&&E()},[]),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[1fr,500px] gap-8 pb-12",children:[e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsxs("div",{className:"flex justify-between items-center gap-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Nueva Factura"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Completa los campos para generar el documento."})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(w,{variant:"outline",onClick:A,children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Cancelar"]}),e.jsxs(w,{onClick:_,children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"Guardar Factura"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(f,{children:[e.jsx(v,{children:e.jsx(N,{className:"text-lg",children:"Información del Cliente"})}),e.jsxs(b,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{children:"Seleccionar Cliente *"}),e.jsxs(F,{value:p,onValueChange:k,children:[e.jsx(V,{children:e.jsx(B,{placeholder:"Busca un cliente..."})}),e.jsx(M,{children:C.map(s=>e.jsxs(y,{value:s.id,children:[s.name," (",s.rif,")"]},s.id))})]})]}),l&&e.jsxs("div",{className:"p-4 bg-muted/50 rounded-lg border text-sm",children:[e.jsxs("p",{className:"font-bold flex items-center justify-between",children:[l.name,e.jsx(L,{variant:"outline",children:l.rif})]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:l.email}),e.jsx("p",{className:"text-muted-foreground",children:l.phone}),e.jsx("p",{className:"text-muted-foreground truncate italic mt-2",children:l.address})]})]})]}),e.jsxs(f,{children:[e.jsx(v,{children:e.jsx(N,{className:"text-lg",children:"Detalles Legales"})}),e.jsxs(b,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{children:"Nº Factura"}),e.jsx(o,{value:i.invoiceNumber,readOnly:!0,className:"bg-muted font-bold"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{children:"Estado"}),e.jsxs(F,{value:i.status,onValueChange:s=>d(a=>({...a,status:s})),children:[e.jsx(V,{children:e.jsx(B,{})}),e.jsxs(M,{children:[e.jsx(y,{value:"draft",children:"Borrador"}),e.jsx(y,{value:"sent",children:"Enviada"}),e.jsx(y,{value:"paid",children:"Pagada"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{children:"Emisión"}),e.jsx(o,{type:"date",value:i.date,onChange:s=>d(a=>({...a,date:s.target.value}))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{children:"Vencimiento"}),e.jsx(o,{type:"date",value:i.dueDate,onChange:s=>d(a=>({...a,dueDate:s.target.value}))})]})]})]})]})]}),e.jsxs(f,{children:[e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0",children:[e.jsx(N,{className:"text-lg font-bold",children:"Items del Recibo"}),e.jsxs(w,{variant:"outline",size:"sm",onClick:E,children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"Agregar Item"]})]}),e.jsxs(b,{children:[e.jsxs(J,{children:[e.jsx(K,{children:e.jsxs(z,{children:[e.jsx(h,{children:"Descripción"}),e.jsx(h,{className:"w-24 text-center",children:"Cant."}),e.jsx(h,{className:"w-32 text-right",children:"Precio"}),e.jsx(h,{className:"w-32 text-right",children:"Total"}),e.jsx(h,{className:"w-12"})]})}),e.jsx(Q,{children:r.map(s=>e.jsxs(z,{children:[e.jsx(j,{children:e.jsx(o,{placeholder:"Descripción...",className:"h-8 border-transparent hover:border-input focus:border-input bg-transparent",value:s.description,onChange:a=>S(s.id,"description",a.target.value)})}),e.jsx(j,{children:e.jsx(o,{type:"number",className:"h-8 text-center",value:s.quantity,onChange:a=>S(s.id,"quantity",a.target.value)})}),e.jsx(j,{children:e.jsx(o,{type:"number",className:"h-8 text-right font-mono",value:s.unitPrice,onChange:a=>S(s.id,"unitPrice",a.target.value)})}),e.jsxs(j,{className:"text-right font-bold",children:["$",s.total.toFixed(2)]}),e.jsx(j,{children:e.jsx(w,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:()=>O(s.id),children:e.jsx(Z,{className:"h-4 w-4"})})})]},s.id))})]}),e.jsxs("div",{className:"mt-6 flex flex-col items-end gap-2 px-4 py-4 bg-muted/20 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between w-64 text-sm text-muted-foreground",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["$",c.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between w-64 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["IVA (",m.taxPercentage,"%):"]}),e.jsxs("span",{children:["$",x.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between w-64 text-xl font-bold pt-2 border-t mt-2",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-primary",children:["$",T.toFixed(2)]})]})]})]})]}),e.jsxs(f,{children:[e.jsx(v,{children:e.jsx(N,{className:"text-lg font-bold",children:"Notas Adicionales"})}),e.jsx(b,{children:e.jsx(X,{className:"min-h-[100px]",placeholder:"Escribe términos de pago, agradecimientos o notas importantes...",value:i.notes,onChange:s=>d(a=>({...a,notes:s.target.value}))})})]})]}),e.jsxs("div",{className:"h-fit sticky top-28",children:[e.jsxs("h3",{className:"text-lg font-bold mb-4 flex items-center justify-between",children:["Vista Previa",e.jsx(L,{variant:"secondary",children:"Renderizado Real"})]}),e.jsx("div",{className:"bg-slate-200/50 p-8 rounded-xl shadow-inner overflow-auto max-h-[80vh] flex justify-center",children:e.jsx("div",{className:"scale-[0.8] origin-top",children:e.jsx(W,{invoice:{...i,items:r,subtotal:c,tax:x,total:T},businessSettings:m,customer:l})})})]})]})};export{ve as default};
