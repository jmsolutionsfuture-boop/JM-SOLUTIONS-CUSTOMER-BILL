---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/layout/Navbar.astro';
---

<Layout title="Facturas - Facturador Digital">
  <Navbar currentPath="/facturas" />
  
  <main class="container">
    <div class="page-header">
      <div>
        <h1>Facturas</h1>
        <p>Gestiona todas tus facturas</p>
      </div>
      <a href="/facturas/nueva" class="btn btn-primary">
        <span>‚ûï</span>
        Nueva Factura
      </a>
    </div>

   <div class="filters-bar">
      <input 
        type="text" 
        id="search-input" 
        class="form-input" 
        placeholder="Buscar facturas..."
      />
      <select id="status-filter" class="form-select">
        <option value="">Todos los estados</option>
        <option value="draft">Borrador</option>
        <option value="sent">Enviada</option>
        <option value="paid">Pagada</option>
      </select>
    </div>

    <div id="invoices-container">
      <!-- Invoices will be loaded here -->
    </div>

    <div id="empty-state" class="empty-state" style="display: none;">
      <p>üìÑ No hay facturas a√∫n. ¬°Crea tu primera factura!</p>
    </div>
  </main>
</Layout>

<script>
  import { storage } from '../../scripts/storage';

  function renderInvoices(searchTerm = '', statusFilter = '') {
    const container = document.getElementById('invoices-container')!;
    const emptyState = document.getElementById('empty-state')!;
    let invoices = storage.getInvoices().sort((a, b) => 
      new Date(b.date).getTime() - new Date(a.date).getTime()
    );

    // Apply filters
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      invoices = invoices.filter(inv => 
        inv.invoiceNumber.toLowerCase().includes(term) ||
        inv.customerName.toLowerCase().includes(term)
      );
    }

    if (statusFilter) {
      invoices = invoices.filter(inv => inv.status === statusFilter);
    }

    if (invoices.length === 0) {
      container.innerHTML = '';
      emptyState.style.display = 'block';
      return;
    }

    emptyState.style.display = 'none';
    container.innerHTML = `
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>N√∫mero</th>
              <th>Cliente</th>
              <th>Fecha</th>
              <th>Vencimiento</th>
              <th>Items</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${invoices.map(invoice => {
              const statusClass = invoice.status === 'paid' ? 'badge-success' : 
                                 invoice.status === 'sent' ? 'badge-warning' : 'badge-info';
              const statusText = invoice.status === 'paid' ? 'Pagada' : 
                                invoice.status === 'sent' ? 'Enviada' : 'Borrador';

              return `
                <tr>
                  <td><strong>${invoice.invoiceNumber}</strong></td>
                  <td>
                    <a href="/clientes/${invoice.customerId}" class="customer-link">
                      ${invoice.customerName}
                    </a>
                  </td>
                  <td>${new Date(invoice.date).toLocaleDateString('es-VE')}</td>
                  <td>${new Date(invoice.dueDate).toLocaleDateString('es-VE')}</td>
                  <td>${invoice.items.length} items</td>
                  <td><strong>$${invoice.total.toFixed(2)}</strong></td>
                  <td><span class="badge ${statusClass}">${statusText}</span></td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn btn-sm btn-outline change-status" data-id="${invoice.id}">
                        üìù
                      </button>
                      <button class="btn btn-sm btn-outline view-invoice" data-id="${invoice.id}">
                        üëÅÔ∏è
                      </button>
                      <button class="btn btn-sm btn-danger delete-invoice" data-id="${invoice.id}">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;

    // Attach event listeners
    document.querySelectorAll('.change-status').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = btn.getAttribute('data-id');
        if (id) changeInvoiceStatus(id);
      });
    });

    document.querySelectorAll('.delete-invoice').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = btn.getAttribute('data-id');
        if (id) deleteInvoice(id);
      });
    });

    document.querySelectorAll('.view-invoice').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = btn.getAttribute('data-id');
        if (id) {
          window.location.href = `/facturas/${id}`;
        }
      });
    });
  }

  function changeInvoiceStatus(id: string) {
    const invoice = storage.getInvoice(id);
    if (!invoice) return;

    const statusOptions = {
      'draft': 'Borrador',
      'sent': 'Enviada',
      'paid': 'Pagada'
    };

    const newStatus = prompt(
      `Estado actual: ${statusOptions[invoice.status]}\n\nNuevo estado:\n1 = Borrador\n2 = Enviada\n3 = Pagada`,
      invoice.status === 'draft' ? '1' : invoice.status === 'sent' ? '2' : '3'
    );

    if (newStatus) {
      const statusMap: Record<string, 'draft' | 'sent' | 'paid'> = {
        '1': 'draft',
        '2': 'sent',
        '3': 'paid'
      };

      if (statusMap[newStatus]) {
        storage.updateInvoice(id, { status: statusMap[newStatus] });
        renderInvoices();
      }
    }
  }

  function deleteInvoice(id: string) {
    const invoice = storage.getInvoice(id);
    if (invoice && confirm(`¬øEliminar factura ${invoice.invoiceNumber}?`)) {
      storage.deleteInvoice(id);
      renderInvoices();
    }
  }

  // Event listeners
  document.getElementById('search-input')!.addEventListener('input', (e) => {
    const searchTerm = (e.target as HTMLInputElement).value;
    const statusFilter = (document.getElementById('status-filter') as HTMLSelectElement).value;
    renderInvoices(searchTerm, statusFilter);
  });

  document.getElementById('status-filter')!.addEventListener('change', (e) => {
    const statusFilter = (e.target as HTMLSelectElement).value;
    const searchTerm = (document.getElementById('search-input') as HTMLInputElement).value;
    renderInvoices(searchTerm, statusFilter);
  });

  // Initial render
  renderInvoices();
</script>

<style>
  main {
    padding: var(--space-2xl) var(--space-lg);
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2xl);
  }

  .page-header h1 {
    margin-bottom: var(--space-sm);
  }

  .page-header p {
    color: var(--text-muted);
  }

  .filters-bar {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
  }

  .table-container {
    overflow-x: auto;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
  }

  .customer-link {
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
  }

  .customer-link:hover {
    text-decoration: underline;
  }

  .action-buttons {
    display: flex;
    gap: var(--space-xs);
  }

  .btn-sm {
    padding: var(--space-xs) var(--space-sm);
    font-size: 0.75rem;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--text-muted);
    font-size: 1.25rem;
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-md);
    }

    .filters-bar {
      grid-template-columns: 1fr;
    }
  }
</style>
