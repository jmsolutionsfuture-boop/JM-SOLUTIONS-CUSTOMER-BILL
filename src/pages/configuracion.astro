---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/layout/Navbar.astro';
---

<Layout title="Configuraci√≥n - Facturador Digital">
  <Navbar currentPath="/configuracion" />
  
  <main class="container">
    <h1>Configuraci√≥n del Negocio</h1>
    <p class="subtitle">Configura los datos de tu empresa que aparecer√°n en las facturas</p>

    <div class="settings-layout">
      <div class="card">
        <h2>Informaci√≥n de la Empresa</h2>
        
        <form id="business-form">
          <div class="form-group">
            <label class="form-label">Nombre de la Empresa *</label>
            <input type="text" id="business-name" class="form-input" required />
          </div>

          <div class="form-group">
            <label class="form-label">RIF *</label>
            <input type="text" id="business-rif" class="form-input" required placeholder="J-12345678-9" />
          </div>

          <div class="form-group">
            <label class="form-label">Direcci√≥n *</label>
            <textarea id="business-address" class="form-textarea" required></textarea>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Tel√©fono *</label>
              <input type="tel" id="business-phone" class="form-input" required placeholder="+58 412-0000000" />
            </div>

            <div class="form-group">
              <label class="form-label">Email *</label>
              <input type="email" id="business-email" class="form-input" required />
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">IVA (%)</label>
              <input type="number" id="business-tax" class="form-input" min="0" max="100" step="0.1" />
            </div>

            <div class="form-group">
              <label class="form-label">Moneda</label>
              <select id="business-currency" class="form-select">
                <option value="USD">USD ($)</option>
                <option value="Bs">Bs (Bol√≠vares)</option>
                <option value="EUR">EUR (‚Ç¨)</option>
              </select>
            </div>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Logo de la Empresa</h2>
        <p class="help-text">Sube el logo de tu empresa (opcional)</p>
        
        <div class="upload-section">
          <div id="logo-preview" class="image-preview">
            <p>Sin logo</p>
          </div>
          <input type="file" id="logo-input" accept="image/*" style="display: none;" />
          <button type="button" class="btn btn-secondary" id="upload-logo-btn">
            üìÅ Seleccionar Logo
          </button>
          <button type="button" class="btn btn-danger" id="remove-logo-btn" style="display: none;">
            üóëÔ∏è Eliminar Logo
          </button>
        </div>
      </div>

      <div class="card">
        <h2>Firma Digital</h2>
        <p class="help-text">Sube tu firma que aparecer√° en las facturas</p>
        
        <div class="upload-section">
          <div id="signature-preview" class="image-preview">
            <p>Sin firma</p>
          </div>
          <input type="file" id="signature-input" accept="image/*" style="display: none;" />
          <button type="button" class="btn btn-secondary" id="upload-signature-btn">
            üìÅ Seleccionar Firma
          </button>
          <button type="button" class="btn btn-danger" id="remove-signature-btn" style="display: none;">
            üóëÔ∏è Eliminar Firma
          </button>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" form="business-form" class="btn btn-success">
        üíæ Guardar Configuraci√≥n
      </button>
    </div>

    <div class="danger-zone">
      <h3>‚ö†Ô∏è Zona de Peligro</h3>
      <p>Estas acciones son irreversibles</p>
      <button type="button" class="btn btn-danger" id="clear-all-btn">
        üóëÔ∏è Eliminar Todos los Datos
      </button>
    </div>
  </main>
</Layout>

<script>
  import { storage } from '../scripts/storage';

  let currentLogo: string | undefined;
  let currentSignature: string | undefined;

  function loadSettings() {
    const settings = storage.getBusinessSettings();

    (document.getElementById('business-name') as HTMLInputElement).value = settings.name;
    (document.getElementById('business-rif') as HTMLInputElement).value = settings.rif;
    (document.getElementById('business-address') as HTMLTextAreaElement).value = settings.address;
    (document.getElementById('business-phone') as HTMLInputElement).value = settings.phone;
    (document.getElementById('business-email') as HTMLInputElement).value = settings.email;
    (document.getElementById('business-tax') as HTMLInputElement).value = settings.taxPercentage.toString();
    (document.getElementById('business-currency') as HTMLSelectElement).value = settings.currency;

    currentLogo = settings.logo;
    currentSignature = settings.signature;

    updateLogoPreview();
    updateSignaturePreview();
  }

  function updateLogoPreview() {
    const preview = document.getElementById('logo-preview')!;
    const removeBtn = document.getElementById('remove-logo-btn')!;

    if (currentLogo) {
      preview.innerHTML = `<img src="${currentLogo}" alt="Logo" />`;
      removeBtn.style.display = 'inline-flex';
    } else {
      preview.innerHTML = '<p>Sin logo</p>';
      removeBtn.style.display = 'none';
    }
  }

  function updateSignaturePreview() {
    const preview = document.getElementById('signature-preview')!;
    const removeBtn = document.getElementById('remove-signature-btn')!;

    if (currentSignature) {
      preview.innerHTML = `<img src="${currentSignature}" alt="Firma" />`;
      removeBtn.style.display = 'inline-flex';
    } else {
      preview.innerHTML = '<p>Sin firma</p>';
      removeBtn.style.display = 'none';
    }
  }

  function convertImageToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // Upload logo
  document.getElementById('upload-logo-btn')!.addEventListener('click', () => {
    document.getElementById('logo-input')!.click();
  });

  document.getElementById('logo-input')!.addEventListener('change', async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      currentLogo = await convertImageToBase64(file);
      updateLogoPreview();
    }
  });

  document.getElementById('remove-logo-btn')!.addEventListener('click', () => {
    currentLogo = undefined;
    updateLogoPreview();
  });

  // Upload signature
  document.getElementById('upload-signature-btn')!.addEventListener('click', () => {
    document.getElementById('signature-input')!.click();
  });

  document.getElementById('signature-input')!.addEventListener('change', async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
      currentSignature = await convertImageToBase64(file);
      updateSignaturePreview();
    }
  });

  document.getElementById('remove-signature-btn')!.addEventListener('click', () => {
    currentSignature = undefined;
    updateSignaturePreview();
  });

  // Save settings
  document.getElementById('business-form')!.addEventListener('submit', (e) => {
    e.preventDefault();

    const settings = {
      name: (document.getElementById('business-name') as HTMLInputElement).value,
      rif: (document.getElementById('business-rif') as HTMLInputElement).value,
      address: (document.getElementById('business-address') as HTMLTextAreaElement).value,
      phone: (document.getElementById('business-phone') as HTMLInputElement).value,
      email: (document.getElementById('business-email') as HTMLInputElement).value,
      taxPercentage: parseFloat((document.getElementById('business-tax') as HTMLInputElement).value),
      currency: (document.getElementById('business-currency') as HTMLSelectElement).value,
      logo: currentLogo,
      signature: currentSignature,
    };

    storage.saveBusinessSettings(settings);
    alert('‚úÖ Configuraci√≥n guardada exitosamente');
  });

  // Clear all data
  document.getElementById('clear-all-btn')!.addEventListener('click', () => {
    if (confirm('‚ö†Ô∏è ADVERTENCIA: Esto eliminar√° TODOS los clientes, facturas y configuraci√≥n.\n\n¬øEst√°s completamente seguro?')) {
      if (confirm('Esta acci√≥n es IRREVERSIBLE. ¬øContinuar?')) {
        storage.clearAll();
        alert('Todos los datos han sido eliminados');
        location.reload();
      }
    }
  });

  // Load settings on page load
  loadSettings();
</script>

<style>
  main {
    padding: var(--space-2xl) var(--space-lg);
    max-width: 900px;
  }

  h1 {
    margin-bottom: var(--space-sm);
  }

  .subtitle {
    color: var(--text-muted);
    margin-bottom: var(--space-2xl);
  }

  .settings-layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .help-text {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-bottom: var(--space-lg);
  }

  .upload-section {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    align-items: center;
  }

  .image-preview {
    width: 200px;
    height: 150px;
    border: 2px dashed var(--border);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-secondary);
    overflow: hidden;
  }

  .image-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .image-preview p {
    color: var(--text-muted);
  }

  .form-actions {
    margin-top: var(--space-2xl);
    display: flex;
    justify-content: center;
  }

  .danger-zone {
    margin-top: var(--space-2xl);
    padding: var(--space-xl);
    border: 2px solid var(--error);
    border-radius: var(--radius-lg);
    text-align: center;
  }

  .danger-zone h3 {
    color: var(--error);
    margin-bottom: var(--space-sm);
  }

  .danger-zone p {
    color: var(--text-muted);
    margin-bottom: var(--space-lg);
  }
</style>
