---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/layout/Navbar.astro';
const { id } = Astro.params;
---

<Layout title="Detalle Factura - Facturador Digital">
  <Navbar currentPath="/facturas" />
  
  <main class="container" data-invoice-id={id}>
    <div class="breadcrumb">
      <a href="/facturas">‚Üê Volver a Facturas</a>
    </div>

    <div class="page-header action-header">
      <h1>Detalle de Factura</h1>
      <div class="header-actions">
        <button id="print-btn" class="btn btn-outline">üñ®Ô∏è Imprimir</button>
        <button id="download-pdf-btn" class="btn btn-primary">‚¨áÔ∏è Descargar PDF</button>
      </div>
    </div>

    <div id="invoice-container" class="invoice-container-view">
      <!-- Invoice content will be loaded here -->
    </div>
  </main>
</Layout>

<script>
  import { storage } from '../../scripts/storage';

  const invoiceId = document.querySelector('main')?.getAttribute('data-invoice-id');

  function loadInvoice() {
    if (!invoiceId) return;

    const invoice = storage.getInvoice(invoiceId);
    const container = document.getElementById('invoice-container');
    const businessSettings = storage.getBusinessSettings();

    if (!invoice || !container) {
      if (container) {
        container.innerHTML = `
          <div class="error-state">
            <h2>Factura no encontrada</h2>
            <a href="/facturas" class="btn btn-primary">Volver a Facturas</a>
          </div>
        `;
      }
      return;
    }

    const customer = storage.getCustomer(invoice.customerId);

    container.innerHTML = `
      <div class="invoice-document" id="invoice-to-print">
        <div class="invoice-header">
          <div class="business-info">
            ${businessSettings.logo ? `<img src="${businessSettings.logo}" alt="Logo" class="business-logo" />` : `<h2>${businessSettings.name}</h2>`}
            <p><strong>RIF:</strong> ${businessSettings.rif}</p>
            <p>${businessSettings.address}</p>
            <p>${businessSettings.phone}</p>
            <p>${businessSettings.email}</p>
          </div>
          <div class="invoice-info">
            <h1 class="invoice-title">FACTURA</h1>
            <div class="invoice-meta">
              <p><strong>N¬∞:</strong> ${invoice.invoiceNumber}</p>
              <p><strong>Fecha:</strong> ${new Date(invoice.date).toLocaleDateString('es-VE')}</p>
              <p><strong>Vencimiento:</strong> ${new Date(invoice.dueDate).toLocaleDateString('es-VE')}</p>
              <div class="invoice-status badge-${invoice.status}">
                 ${invoice.status === 'paid' ? 'PAGADA' : invoice.status === 'sent' ? 'ENVIADA' : 'BORRADOR'}
              </div>
            </div>
          </div>
        </div>

        <div class="customer-section">
          <h3>Cliente</h3>
          <div class="customer-info">
            <p><strong>Raz√≥n Social:</strong> ${invoice.customerName}</p>
            ${customer ? `
              <p><strong>RIF/CI:</strong> ${customer.rif}</p>
              <p><strong>Direcci√≥n:</strong> ${customer.address}</p>
              <p><strong>Tel√©fono:</strong> ${customer.phone}</p>
            ` : '<p>Cliente no disponible</p>'}
          </div>
        </div>

        <table class="invoice-table">
          <thead>
            <tr>
              <th class="col-desc">Descripci√≥n</th>
              <th class="col-qty">Cant.</th>
              <th class="col-price">Precio Unit.</th>
              <th class="col-total">Total</th>
            </tr>
          </thead>
          <tbody>
            ${invoice.items.map(item => `
              <tr>
                <td>${item.description}</td>
                <td class="text-center">${item.quantity}</td>
                <td class="text-right">${businessSettings.currency} ${item.unitPrice.toFixed(2)}</td>
                <td class="text-right">${businessSettings.currency} ${item.total.toFixed(2)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <div class="invoice-footer">
          <div class="invoice-notes">
            ${invoice.notes ? `
              <h4>Notas:</h4>
              <p>${invoice.notes}</p>
            ` : ''}
          </div>
          <div class="invoice-totals">
            <div class="total-row">
              <span>Subtotal:</span>
              <span>${businessSettings.currency} ${invoice.subtotal.toFixed(2)}</span>
            </div>
            <div class="total-row">
              <span>IVA (${invoice.taxPercentage}%):</span>
              <span>${businessSettings.currency} ${invoice.tax.toFixed(2)}</span>
            </div>
            <div class="total-row grand-total">
              <span>Total:</span>
              <span>${businessSettings.currency} ${invoice.total.toFixed(2)}</span>
            </div>
          </div>
        </div>

        ${businessSettings.signature ? `
          <div class="signature-section">
            <img src="${businessSettings.signature}" alt="Firma Autorizada" class="signature-img" />
            <p>Firma Autorizada</p>
          </div>
        ` : ''}
      </div>
    `;
  }

  loadInvoice();

  document.getElementById('print-btn')?.addEventListener('click', () => {
    window.print();
  });

  document.getElementById('download-pdf-btn')?.addEventListener('click', () => {
    alert('Funcionalidad de PDF pendiente de a√±adir librer√≠a externa html2pdf');
    window.print(); // Fallback to print for now
  });
</script>

<style>
  main {
    padding: var(--space-2xl) var(--space-lg);
  }

  .breadcrumb {
    margin-bottom: var(--space-lg);
  }
  
  .breadcrumb a {
    color: var(--primary);
    text-decoration: none;
  }

  .action-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
  }

  .header-actions {
    display: flex;
    gap: var(--space-md);
  }

  .invoice-container-view {
    max-width: 900px;
    margin: 0 auto;
    background: white;
    padding: var(--space-2xl);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    min-height: 800px;
  }

  /* Invoice Document Styles */
  .invoice-document {
    color: #1f2937;
    font-family: 'Inter', sans-serif;
  }

  .invoice-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .business-logo {
    max-height: 80px;
    margin-bottom: 1rem;
  }

  .business-info h2 {
    color: var(--primary);
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
  }

  .business-info p {
    margin: 0.25rem 0;
    font-size: 0.9rem;
    color: #4b5563;
  }

  .invoice-info {
    text-align: right;
  }

  .invoice-title {
    color: var(--primary);
    font-size: 2.5rem;
    margin-bottom: 1rem;
    letter-spacing: 2px;
  }

  .invoice-meta p {
    margin: 0.25rem 0;
    font-size: 1rem;
  }

  .invoice-status {
    display: inline-block;
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
  }

  .badge-paid { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
  .badge-sent { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
  .badge-draft { background: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }

  .customer-section {
    margin-bottom: 2.5rem;
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 8px;
  }

  .customer-section h3 {
    color: var(--primary);
    margin-bottom: 1rem;
    font-size: 1.1rem;
    text-transform: uppercase;
  }

  .customer-info p {
    margin: 0.25rem 0;
  }

  .invoice-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 2.5rem;
  }

  .invoice-table th {
    background: var(--primary);
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
  }

  .invoice-table td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .col-desc { width: 40%; }
  .col-qty { width: 15%; text-align: center; }
  .col-price { width: 20%; text-align: right; }
  .col-total { width: 25%; text-align: right; }

  .text-center { text-align: center; }
  .text-right { text-align: right; }

  .invoice-footer {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3rem;
  }

  .invoice-notes {
    width: 50%;
    color: #6b7280;
    font-size: 0.9rem;
  }

  .invoice-notes h4 {
    color: #374151;
    margin-bottom: 0.5rem;
  }

  .invoice-totals {
    width: 40%;
  }

  .total-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .grand-total {
    border-top: 2px solid #374151;
    border-bottom: none;
    margin-top: 0.5rem;
    padding-top: 1rem;
    font-weight: bold;
    font-size: 1.25rem;
    color: var(--primary);
  }

  .signature-section {
    text-align: center;
    margin-top: 2rem;
  }

  .signature-img {
    max-height: 100px;
    margin-bottom: 0.5rem;
  }

  @media print {
    body {
      background: white;
    }
    .navbar, .breadcrumb, .action-header, .no-print {
      display: none !important;
    }
    .invoice-container-view {
      box-shadow: none;
      margin: 0;
      padding: 0;
      width: 100%;
      max-width: none;
    }
    main { padding: 0; }
  }
</style>
